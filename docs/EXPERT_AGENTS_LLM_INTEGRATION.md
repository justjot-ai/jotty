# Expert Agents with LLM Integration

## Architecture Overview

Expert Agents are built on top of **Jotty's core agents** which leverage **DSPy** and **LLMs (Claude/Cursor)**. The OptimizationPipeline trains these LLM-based agents to make them perfect.

## Architecture Flow

```
Expert Agent
    â”‚
    â”œâ”€ Uses DSPy Module (LLM-based)
    â”‚   â”œâ”€ Claude/Cursor for generation
    â”‚   â””â”€ Generates diagrams from descriptions
    â”‚
    â””â”€ OptimizationPipeline
        â”œâ”€ Trains the DSPy module
        â”œâ”€ Uses teacher model for corrections
        â”œâ”€ Stores improvements
        â””â”€ Makes agent "perfect"
```

## How It Works

### 1. Expert Agent Creation

Expert agents use **DSPy signatures** that define what the LLM should do:

```python
class MermaidGenerationSignature(dspy.Signature):
    """Generate a Mermaid diagram from a description."""
    task: str = dspy.InputField(desc="Task description")
    description: str = dspy.InputField(desc="Description of the diagram")
    diagram_type: str = dspy.InputField(desc="Type of diagram")
    learned_improvements: str = dspy.InputField(desc="Previously learned patterns")
    
    output: str = dspy.OutputField(desc="Complete Mermaid diagram code")
```

### 2. DSPy Module Creation

The expert agent creates a DSPy module:

```python
agent = dspy.ChainOfThought(MermaidGenerationSignature)
```

This module uses the configured LLM (Claude/Cursor) to generate diagrams.

### 3. Training with OptimizationPipeline

The OptimizationPipeline trains the DSPy module:

```python
pipeline = create_optimization_pipeline(
    agents=[agent_config],
    enable_teacher_model=True,
    ...
)

# Train on gold standards
result = await pipeline.optimize(
    task="Generate flowchart",
    context={"description": "..."},
    gold_standard="graph TD\n    A[Start]\n    B[End]\n    A --> B"
)
```

### 4. Learning Process

1. **Agent generates** diagram using LLM (Claude/Cursor)
2. **Evaluation** checks if it matches gold standard
3. **Teacher provides** correct diagram if needed
4. **Improvements stored** for future use
5. **DSPy instructions updated** (optional) with learned patterns

### 5. Perfect Generation

After training, the expert agent:
- Uses LLM to generate from descriptions
- Applies learned improvements
- Always produces correct outputs

## Benefits

### âœ… LLM-Powered Generation

- **Claude/Cursor**: Uses powerful LLMs for generation
- **Description Understanding**: LLMs understand natural language descriptions
- **Flexible**: Can handle any description, not just templates

### âœ… OptimizationPipeline Training

- **Self-Improvement**: Trains the LLM agent to be perfect
- **Teacher Model**: Provides corrections when needed
- **Continuous Learning**: Improves over time

### âœ… Best of Both Worlds

- **LLM Intelligence**: For understanding descriptions and generating diagrams
- **OptimizationPipeline**: For ensuring correctness and learning

## Example Usage

```python
from jotty.core.experts import get_mermaid_expert_async
import dspy

# Configure LLM (Claude/Cursor)
dspy.configure(lm=dspy.LM(model="claude-3-opus"))

# Get expert (auto-trains if needed)
expert = await get_mermaid_expert_async(auto_train=True)

# Generate diagram from description
diagram = await expert.generate_mermaid(
    description="Complex decision tree with multiple branches and conditions",
    diagram_type="flowchart"
)

print(diagram)
# Output: Perfect Mermaid diagram generated by Claude/Cursor
```

## DSPy Integration Details

### Signature Design

Expert agents use DSPy signatures that:
- Define inputs (task, description, diagram_type)
- Define outputs (Mermaid diagram code)
- Include learned improvements as input

### Module Types

- **ChainOfThought**: For complex reasoning (generation)
- **Predict**: For simple predictions (teacher)

### LLM Configuration

Expert agents use the LLM configured in DSPy:

```python
import dspy

# Configure Claude
dspy.configure(lm=dspy.LM(model="claude-3-opus"))

# Or Cursor
dspy.configure(lm=dspy.LM(model="cursor"))
```

## Training Process

### Step 1: Initial Generation

```python
# Agent uses LLM to generate
result = agent(
    task="Generate flowchart",
    description="User login flow",
    diagram_type="flowchart"
)
# LLM generates: "graph TD\n    A[Login]\n    B[Validate]..."
```

### Step 2: Evaluation

```python
# Check if matches gold standard
score = evaluate(result.output, gold_standard)
# Score: 0.5 (partial match)
```

### Step 3: Teacher Correction

```python
# Teacher provides correct diagram
teacher_result = teacher(
    task="Generate flowchart",
    gold_standard="graph TD\n    A[Start]\n    B[End]\n    A --> B"
)
# Teacher output: Perfect diagram
```

### Step 4: Learning

```python
# Store improvement
improvement = {
    "student_output": result.output,
    "teacher_output": teacher_result.output,
    "learned_pattern": "When generating flowcharts, use proper node definitions..."
}
```

### Step 5: Perfect Agent

```python
# Next time, agent uses learned patterns
result = agent(
    task="Generate flowchart",
    description="New flow",
    learned_improvements="When generating flowcharts..."
)
# Generates perfect diagram!
```

## Advantages Over Template-Based Approach

| Aspect | Template-Based | LLM-Based (Current) |
|--------|----------------|---------------------|
| **Flexibility** | Limited to templates | Handles any description |
| **Understanding** | Pattern matching | Natural language understanding |
| **Complexity** | Simple but limited | Complex but powerful |
| **Maintenance** | Need to add templates | Learns automatically |
| **Quality** | Consistent but basic | High quality with training |

## Conclusion

Expert Agents now leverage:
1. **Jotty's core agents** (DSPy modules)
2. **LLMs (Claude/Cursor)** for generation
3. **OptimizationPipeline** for training and perfection

This creates expert agents that:
- âœ… Understand natural language descriptions
- âœ… Generate appropriate diagrams
- âœ… Learn from mistakes
- âœ… Become perfect through training

**Expert Agents = LLM-Powered + OptimizationPipeline-Trained = Perfect!** ðŸŽ‰
