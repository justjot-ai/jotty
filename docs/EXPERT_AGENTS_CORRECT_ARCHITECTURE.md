# Expert Agents - Correct Architecture

## âœ… Correct Architecture

Expert Agents are built on top of **Jotty's core agents** which leverage **DSPy** and **LLMs (Claude/Cursor)**. The OptimizationPipeline trains these LLM-based agents to make them perfect.

## Architecture Flow

```
User Request
    â”‚
    â–¼
Expert Agent
    â”‚
    â”œâ”€ Uses DSPy Module (LLM-based)
    â”‚   â”œâ”€ Claude/Cursor for generation
    â”‚   â”œâ”€ ChainOfThought for reasoning
    â”‚   â””â”€ Generates diagrams from descriptions
    â”‚
    â””â”€ OptimizationPipeline (Training)
        â”œâ”€ Trains the DSPy module
        â”œâ”€ Uses teacher model for corrections
        â”œâ”€ Stores improvements
        â””â”€ Makes agent "perfect"
```

## Key Components

### 1. DSPy Signature

Expert agents define DSPy signatures that tell the LLM what to do:

```python
class MermaidGenerationSignature(dspy.Signature):
    """Generate a Mermaid diagram from a description."""
    task: str = dspy.InputField(desc="Task description")
    description: str = dspy.InputField(desc="Description of the diagram")
    diagram_type: str = dspy.InputField(desc="Type of diagram")
    learned_improvements: str = dspy.InputField(desc="Previously learned patterns")
    
    output: str = dspy.OutputField(desc="Complete Mermaid diagram code")
```

### 2. DSPy Module

Create a DSPy module from the signature:

```python
agent = dspy.ChainOfThought(MermaidGenerationSignature)
```

This module uses the configured LLM (Claude/Cursor) to generate diagrams.

### 3. OptimizationPipeline Training

The OptimizationPipeline trains the DSPy module:

```python
pipeline = create_optimization_pipeline(
    agents=[AgentConfig(name="mermaid_generator", agent=agent)],
    enable_teacher_model=True,
    ...
)

# Train on gold standards
result = await pipeline.optimize(
    task="Generate flowchart",
    context={"description": "User login flow"},
    gold_standard="graph TD\n    A[Start]\n    B[End]\n    A --> B"
)
```

### 4. Learning Process

1. **Agent generates** diagram using LLM (Claude/Cursor)
2. **Evaluation** checks if it matches gold standard
3. **Teacher provides** correct diagram if needed
4. **Improvements stored** for future use
5. **DSPy instructions updated** (optional) with learned patterns

## Usage Example

```python
import dspy
from jotty.core.experts import get_mermaid_expert_async

# Configure LLM (Claude/Cursor)
dspy.configure(lm=dspy.LM(model="claude-3-opus"))
# Or for Cursor:
# dspy.configure(lm=dspy.LM(model="cursor"))

# Get expert (auto-trains if needed)
expert = await get_mermaid_expert_async(auto_train=True)

# Generate diagram from description
diagram = await expert.generate_mermaid(
    description="Complex decision tree with multiple branches and conditions",
    diagram_type="flowchart"
)

print(diagram)
# Output: Perfect Mermaid diagram generated by Claude/Cursor
```

## Benefits

### âœ… LLM-Powered Generation

- **Claude/Cursor**: Uses powerful LLMs for generation
- **Description Understanding**: LLMs understand natural language descriptions
- **Flexible**: Can handle any description, not just templates

### âœ… OptimizationPipeline Training

- **Self-Improvement**: Trains the LLM agent to be perfect
- **Teacher Model**: Provides corrections when needed
- **Continuous Learning**: Improves over time

### âœ… Best of Both Worlds

- **LLM Intelligence**: For understanding descriptions and generating diagrams
- **OptimizationPipeline**: For ensuring correctness and learning

## How It Differs from Previous Implementation

### âŒ Previous (Wrong)

```python
class MermaidAgent:
    def forward(self, description=None, **kwargs):
        # Returns learned pattern or default diagram
        return learned_pattern or default_diagram
```

**Problem**: Doesn't actually generate from descriptions, just returns patterns.

### âœ… Current (Correct)

```python
class MermaidGenerationSignature(dspy.Signature):
    description: str = dspy.InputField(...)
    output: str = dspy.OutputField(...)

agent = dspy.ChainOfThought(MermaidGenerationSignature)
# Uses LLM to generate from description!
```

**Solution**: Uses LLM to actually generate diagrams from descriptions.

## Training Process

### Step 1: LLM Generates

```python
# Agent uses LLM (Claude/Cursor) to generate
result = agent(
    task="Generate flowchart",
    description="User login flow",
    diagram_type="flowchart"
)
# LLM generates: "graph TD\n    A[Login]\n    B[Validate]..."
```

### Step 2: Evaluation

```python
# Check if matches gold standard
score = evaluate(result.output, gold_standard)
# Score: 0.5 (partial match)
```

### Step 3: Teacher Correction

```python
# Teacher provides correct diagram
teacher_result = teacher(
    task="Generate flowchart",
    gold_standard="graph TD\n    A[Start]\n    B[End]\n    A --> B"
)
# Teacher output: Perfect diagram
```

### Step 4: Learning

```python
# Store improvement
improvement = {
    "student_output": result.output,
    "teacher_output": teacher_result.output,
    "learned_pattern": "When generating flowcharts..."
}
```

### Step 5: Perfect Agent

```python
# Next time, agent uses learned patterns + LLM
result = agent(
    task="Generate flowchart",
    description="New flow",
    learned_improvements="When generating flowcharts..."
)
# Generates perfect diagram using LLM + learned patterns!
```

## Configuration

### LLM Setup

```python
import dspy

# Option 1: Claude
dspy.configure(lm=dspy.LM(model="claude-3-opus"))

# Option 2: Cursor
dspy.configure(lm=dspy.LM(model="cursor"))

# Option 3: OpenAI
dspy.configure(lm=dspy.LM(model="openai/gpt-4"))
```

## Conclusion

Expert Agents now correctly:
1. âœ… Use **Jotty's core agents** (DSPy modules)
2. âœ… Leverage **LLMs (Claude/Cursor)** for generation
3. âœ… Are trained by **OptimizationPipeline** for perfection

This creates expert agents that:
- âœ… Understand natural language descriptions
- âœ… Generate appropriate diagrams using LLMs
- âœ… Learn from mistakes via OptimizationPipeline
- âœ… Become perfect through training

**Expert Agents = LLM-Powered (Claude/Cursor) + OptimizationPipeline-Trained = Perfect!** ðŸŽ‰
