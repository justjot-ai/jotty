# Pre-commit hooks for Jotty
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Code formatting
  - repo: https://github.com/psf/black
    rev: 24.1.0
    hooks:
      - id: black
        language_version: python3.11
        args: [--line-length=100]
        exclude: ^(apps/_archived/|tests/manual/)

  # Import sorting
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: [--profile=black, --line-length=100]

  # Basic checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-merge-conflict
      - id: debug-statements
      - id: mixed-line-ending

  # Python lint (config in .flake8). Exclude archived and manual test files.
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        exclude: ^(apps/_archived/|tests/manual/)

  # Security checks
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        args: [-c, .bandit.yaml, -r, Jotty/]
        pass_filenames: false

  # Type checking with mypy (only fail on syntax/import errors for now)
  - repo: local
    hooks:
      - id: mypy-critical
        name: mypy - Critical Errors Only (syntax, imports)
        entry: bash -c 'mypy core/ apps/ sdk/ --config-file=mypy.ini 2>&1 | grep -E "(syntax|import-not-found)" && exit 1 || exit 0'
        language: system
        pass_filenames: false
        always_run: true

  # Custom Jotty checks
  - repo: local
    hooks:
      - id: python-syntax-check
        name: Python AST Syntax Validation
        entry: python3 -c "import sys, ast; [ast.parse(open(f).read()) for f in sys.argv[1:]]"
        language: system
        types: [python]
        pass_filenames: true

      - id: import-linter
        name: Import Linter - Architecture Enforcement
        entry: bash -c 'lint-imports 2>/dev/null || python3 -m importlinter.cli 2>/dev/null || true'
        language: system
        pass_filenames: false
        always_run: true

      - id: jotty-doctor-imports
        name: Jotty Doctor - Import Check (informational)
        entry: bash -c 'python3 scripts/jotty_doctor.py --imports || true'
        language: system
        pass_filenames: false
        always_run: true

      - id: jotty-doctor-secrets
        name: Jotty Doctor - Security Scan
        entry: python3 scripts/jotty_doctor.py --secrets
        language: system
        pass_filenames: false
        always_run: true
