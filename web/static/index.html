<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jotty - AI Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <style>
/* Jotty Web UI - LibreChat-inspired Design */
:root {
    --bg-primary: #0d0d0d;
    --bg-secondary: #171717;
    --bg-tertiary: #212121;
    --bg-hover: #2a2a2a;
    --bg-input: #1e1e1e;
    --text-primary: #e5e5e5;
    --text-secondary: #a1a1a1;
    --text-muted: #6b6b6b;
    --accent: #10a37f;
    --accent-hover: #0d8c6d;
    --border-color: #2d2d2d;
    --error: #ef4444;
    --success: #10a37f;
    --code-bg: #1a1a1a;
    --scrollbar-thumb: #4a4a4a;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; }
.app-container { display: flex; height: 100vh; }
.sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.3s ease; }
.sidebar.hidden { transform: translateX(-100%); position: absolute; }
.sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
.new-chat-btn { width: 100%; padding: 12px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
.new-chat-btn:hover { background: var(--bg-hover); }
.new-chat-btn svg { width: 16px; height: 16px; }
.sessions-list { flex: 1; overflow-y: auto; padding: 8px; }
.sessions-list::-webkit-scrollbar { width: 6px; }
.sessions-list::-webkit-scrollbar-track { background: transparent; }
.sessions-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
.session-group { margin-bottom: 16px; }
.session-group-title { font-size: 12px; font-weight: 500; color: var(--text-muted); padding: 8px 12px; text-transform: uppercase; letter-spacing: 0.05em; }
.session-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s; }
.session-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.session-item.active { background: var(--bg-tertiary); color: var(--text-primary); }
.sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-muted); }
.main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; }
.menu-toggle { display: none; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 6px; }
.menu-toggle:hover { background: var(--bg-hover); }
.header-title { font-size: 16px; font-weight: 500; }
.session-id { font-size: 12px; color: var(--text-muted); font-family: monospace; }
.chat-area { flex: 1; overflow-y: auto; padding: 0; }
.chat-area::-webkit-scrollbar { width: 8px; }
.chat-area::-webkit-scrollbar-track { background: transparent; }
.chat-area::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
.messages-container { max-width: 800px; margin: 0 auto; padding: 24px; }
.message { display: flex; gap: 16px; margin-bottom: 24px; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.message-avatar { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.message.user .message-avatar { background: var(--accent); color: white; }
.message.assistant .message-avatar { background: var(--bg-tertiary); color: var(--text-primary); }
.message-content { flex: 1; min-width: 0; }
.message-role { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.message.user .message-role { color: var(--text-primary); }
.message.assistant .message-role { color: var(--accent); }
.message-text { font-size: 15px; line-height: 1.6; color: var(--text-primary); word-wrap: break-word; }
.message-text p { margin-bottom: 12px; }
.message-text p:last-child { margin-bottom: 0; }
.message-text code { background: var(--code-bg); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 13px; }
.message-text pre { background: var(--code-bg); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
.message-text pre code { background: none; padding: 0; }
.message-text ul, .message-text ol { margin: 12px 0; padding-left: 24px; }
.message-text li { margin-bottom: 6px; }
.message-text h1, .message-text h2, .message-text h3 { margin-top: 20px; margin-bottom: 12px; }
.message-text h1 { font-size: 20px; }
.message-text h2 { font-size: 18px; }
.message-text h3 { font-size: 16px; }
.message-meta { margin-top: 8px; font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 12px; }
.message-interface { padding: 2px 6px; background: var(--bg-tertiary); border-radius: 4px; text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; }
.output-path { color: var(--accent); font-family: monospace; }
.status-indicator { display: flex; align-items: center; gap: 8px; padding: 12px 16px; margin: 16px 0; background: var(--bg-tertiary); border-radius: 8px; font-size: 14px; color: var(--text-secondary); }
.status-spinner { width: 16px; height: 16px; border: 2px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.input-area { padding: 16px 24px 24px; border-top: 1px solid var(--border-color); background: var(--bg-primary); }
.input-container { max-width: 800px; margin: 0 auto; position: relative; }
.input-wrapper { display: flex; align-items: flex-end; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 12px; transition: border-color 0.2s; }
.input-wrapper:focus-within { border-color: var(--accent); }
.message-input { flex: 1; background: none; border: none; padding: 14px 16px; font-size: 15px; color: var(--text-primary); resize: none; min-height: 24px; max-height: 200px; outline: none; font-family: inherit; line-height: 1.5; }
.message-input::placeholder { color: var(--text-muted); }
.send-btn { padding: 10px 14px; margin: 4px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s, opacity 0.2s; }
.send-btn:hover:not(:disabled) { background: var(--accent-hover); }
.send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.send-btn svg { width: 18px; height: 18px; }
.input-hint { margin-top: 8px; font-size: 12px; color: var(--text-muted); text-align: center; }
.welcome-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 24px; text-align: center; }
.welcome-logo { font-size: 48px; margin-bottom: 16px; }
.welcome-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
.welcome-subtitle { font-size: 16px; color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; }
.examples-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-width: 600px; width: 100%; }
.example-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; text-align: left; transition: background 0.2s, border-color 0.2s; }
.example-card:hover { background: var(--bg-tertiary); border-color: var(--accent); }
.example-icon { font-size: 20px; margin-bottom: 8px; }
.example-text { font-size: 14px; color: var(--text-secondary); }
.error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: 8px; padding: 12px 16px; margin: 16px 0; color: var(--error); font-size: 14px; }
.connection-status { position: fixed; top: 16px; right: 16px; padding: 8px 12px; border-radius: 6px; font-size: 12px; display: flex; align-items: center; gap: 6px; z-index: 100; }
.connection-status.connected { background: rgba(16, 163, 127, 0.2); color: var(--success); }
.connection-status.disconnected { background: rgba(239, 68, 68, 0.2); color: var(--error); }
.connection-dot { width: 8px; height: 8px; border-radius: 50%; }
.connection-status.connected .connection-dot { background: var(--success); }
.connection-status.disconnected .connection-dot { background: var(--error); }
@media (max-width: 768px) {
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; z-index: 50; transform: translateX(-100%); }
    .sidebar.visible { transform: translateX(0); }
    .menu-toggle { display: block; }
    .messages-container { padding: 16px; }
    .input-area { padding: 12px 16px 16px; }
    .examples-grid { grid-template-columns: 1fr; }
}
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                </button>
            </div>
            <div class="sessions-list" id="sessions-list"></div>
            <div class="sidebar-footer">
                <div>Jotty v1.0</div>
                <div style="margin-top: 4px;">Multi-Agent AI Assistant</div>
            </div>
        </aside>
        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" id="menu-toggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <span class="header-title">Jotty</span>
                <span class="session-id" id="session-id"></span>
            </header>
            <div class="connection-status disconnected" id="connection-status">
                <span class="connection-dot"></span>
                Connecting...
            </div>
            <div class="chat-area" id="chat-area">
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-logo">ü§ñ</div>
                    <h1 class="welcome-title">Welcome to Jotty</h1>
                    <p class="welcome-subtitle">Your AI assistant for research, writing, analysis, and more. Start a conversation or try one of these examples:</p>
                    <div class="examples-grid">
                        <div class="example-card"><div class="example-icon">üîç</div><div class="example-text">Search for the latest AI news</div></div>
                        <div class="example-card"><div class="example-icon">üìù</div><div class="example-text">Create a checklist for project management</div></div>
                        <div class="example-card"><div class="example-icon">üß†</div><div class="example-text">Explain how transformers work</div></div>
                        <div class="example-card"><div class="example-icon">üìä</div><div class="example-text">Analyze market trends for 2024</div></div>
                    </div>
                </div>
                <div class="messages-container" id="messages-container" style="display: none;"></div>
            </div>
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea class="message-input" id="message-input" placeholder="Message Jotty..." rows="1"></textarea>
                        <button class="send-btn" id="send-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                    <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
                </div>
            </div>
        </main>
    </div>
    <script>
class JottyApp {
    constructor() {
        this.sessionId = null;
        this.ws = null;
        this.messages = [];
        this.isProcessing = false;
        this.streamingContent = '';
        // Detect proxy path and build URLs accordingly
        const path = window.location.pathname;
        const proxyMatch = path.match(/^(\/proxy\/\d+)/);
        if (proxyMatch) {
            // Running behind proxy - use proxy-relative paths
            this.apiBase = proxyMatch[1];
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.wsBase = `${wsProtocol}//${window.location.host}${proxyMatch[1]}`;
        } else {
            // Direct access - use relative paths
            this.apiBase = '';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.wsBase = `${wsProtocol}//${window.location.host}`;
        }
        this.init();
    }
    init() {
        this.chatArea = document.getElementById('chat-area');
        this.messagesContainer = document.getElementById('messages-container');
        this.messageInput = document.getElementById('message-input');
        this.sendBtn = document.getElementById('send-btn');
        this.newChatBtn = document.getElementById('new-chat-btn');
        this.sessionsList = document.getElementById('sessions-list');
        this.sessionIdDisplay = document.getElementById('session-id');
        this.menuToggle = document.getElementById('menu-toggle');
        this.sidebar = document.getElementById('sidebar');
        this.connectionStatus = document.getElementById('connection-status');
        this.welcomeScreen = document.getElementById('welcome-screen');
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.messageInput.addEventListener('input', () => this.autoResize());
        this.newChatBtn.addEventListener('click', () => this.newChat());
        this.menuToggle?.addEventListener('click', () => this.toggleSidebar());
        document.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                const text = card.querySelector('.example-text').textContent;
                this.messageInput.value = text;
                this.messageInput.focus();
                this.autoResize();
            });
        });
        this.loadSessions();
        this.newChat();
    }
    generateSessionId() { return 'web_' + Math.random().toString(36).substr(2, 8); }
    async loadSessions() {
        try {
            const response = await fetch(`${this.apiBase}/api/sessions`);
            const data = await response.json();
            this.renderSessions(data.sessions || []);
        } catch (error) { console.error('Failed to load sessions:', error); }
    }
    renderSessions(sessions) {
        if (!this.sessionsList) return;
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        const grouped = { today: [], yesterday: [], older: [] };
        sessions.forEach(session => {
            const date = new Date(session.created_at).toDateString();
            if (date === today) grouped.today.push(session);
            else if (date === yesterday) grouped.yesterday.push(session);
            else grouped.older.push(session);
        });
        let html = '';
        if (grouped.today.length > 0) html += this.renderSessionGroup('Today', grouped.today);
        if (grouped.yesterday.length > 0) html += this.renderSessionGroup('Yesterday', grouped.yesterday);
        if (grouped.older.length > 0) html += this.renderSessionGroup('Previous', grouped.older);
        this.sessionsList.innerHTML = html || '<div class="session-item">No sessions yet</div>';
        this.sessionsList.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', () => { const id = item.dataset.sessionId; if (id) this.loadSession(id); });
        });
    }
    renderSessionGroup(title, sessions) {
        return `<div class="session-group"><div class="session-group-title">${title}</div>${sessions.map(s => `<div class="session-item ${s.session_id === this.sessionId ? 'active' : ''}" data-session-id="${s.session_id}">${this.getSessionTitle(s)}</div>`).join('')}</div>`;
    }
    getSessionTitle(session) {
        if (session.history && session.history.length > 0) {
            const firstUser = session.history.find(m => m.role === 'user');
            if (firstUser) return firstUser.content.substring(0, 30) + (firstUser.content.length > 30 ? '...' : '');
        }
        return `Session ${session.session_id}`;
    }
    async loadSession(sessionId) {
        try {
            const response = await fetch(`${this.apiBase}/api/sessions/${sessionId}`);
            if (!response.ok) throw new Error('Session not found');
            const session = await response.json();
            this.sessionId = sessionId;
            this.messages = session.history || [];
            this.updateSessionDisplay();
            this.renderMessages();
            this.updateConnectionStatus(true);
            this.loadSessions();
            if (this.welcomeScreen) this.welcomeScreen.style.display = 'none';
            if (this.messagesContainer) this.messagesContainer.style.display = 'block';
        } catch (error) { console.error('Failed to load session:', error); }
    }
    newChat() {
        this.sessionId = this.generateSessionId();
        this.messages = [];
        this.updateSessionDisplay();
        this.renderMessages();
        this.updateConnectionStatus(true); // SSE is always "ready"
        if (this.welcomeScreen) this.welcomeScreen.style.display = 'flex';
        if (this.messagesContainer) this.messagesContainer.style.display = 'none';
        this.messageInput.focus();
    }
    updateSessionDisplay() { if (this.sessionIdDisplay) this.sessionIdDisplay.textContent = this.sessionId; }
    updateConnectionStatus(connected) {
        if (this.connectionStatus) {
            this.connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            this.connectionStatus.innerHTML = `<span class="connection-dot"></span>${connected ? 'Ready' : 'Disconnected'}`;
        }
    }
    handleSSEMessage(data) {
        switch (data.type) {
            case 'connected': console.log('SSE connected, session:', data.session_id); break;
            case 'stream': this.handleStreamChunk(data.chunk); break;
            case 'status': this.updateStatus(data.stage, data.detail); break;
            case 'complete': this.handleCompleteSSE(data.result); break;
            case 'error': this.handleError(data.error); break;
        }
    }
    handleCompleteSSE(result) {
        if (result && result.success) {
            this.handleComplete({ content: result.content, output_path: result.output_path });
        } else {
            this.handleError(result?.error || 'Unknown error');
        }
    }
    handleStreamChunk(chunk) { this.streamingContent += chunk; this.updateStreamingMessage(); }
    updateStreamingMessage() {
        const streamingEl = document.getElementById('streaming-message');
        if (streamingEl) { const textEl = streamingEl.querySelector('.message-text'); if (textEl) textEl.innerHTML = this.renderMarkdown(this.streamingContent); }
    }
    handleComplete(data) {
        this.isProcessing = false;
        this.streamingContent = '';
        const statusEl = document.getElementById('status-indicator');
        if (statusEl) statusEl.remove();
        const streamingEl = document.getElementById('streaming-message');
        if (streamingEl) {
            streamingEl.removeAttribute('id');
            const textEl = streamingEl.querySelector('.message-text');
            if (textEl) textEl.innerHTML = this.renderMarkdown(data.content);
            if (data.output_path) { const metaEl = streamingEl.querySelector('.message-meta'); if (metaEl) metaEl.innerHTML += `<span class="output-path">Saved: ${data.output_path}</span>`; }
        }
        this.messages.push({ role: 'assistant', content: data.content, interface: 'web', output_path: data.output_path });
        this.setProcessing(false);
        this.loadSessions();
    }
    handleError(error) {
        this.isProcessing = false;
        this.streamingContent = '';
        this.setProcessing(false);
        const statusEl = document.getElementById('status-indicator');
        if (statusEl) statusEl.remove();
        const streamingEl = document.getElementById('streaming-message');
        if (streamingEl) streamingEl.remove();
        this.addErrorMessage(error);
    }
    updateStatus(stage, detail) {
        let statusEl = document.getElementById('status-indicator');
        if (!statusEl) { statusEl = document.createElement('div'); statusEl.id = 'status-indicator'; statusEl.className = 'status-indicator'; this.messagesContainer.appendChild(statusEl); }
        const emojis = { 'processing': '‚öôÔ∏è', 'analyzing': 'üîç', 'searching': 'üåê', 'reading': 'üìñ', 'generating': '‚ú®', 'generated': '‚úÖ', 'saving': 'üíæ', 'saved': 'üìÅ', 'decision': 'ü§î' };
        const emoji = emojis[stage.toLowerCase()] || '‚öôÔ∏è';
        statusEl.innerHTML = `<div class="status-spinner"></div><span>${emoji} ${stage.charAt(0).toUpperCase() + stage.slice(1)}${detail ? ': ' + detail : ''}</span>`;
        this.scrollToBottom();
    }
    async sendMessage() {
        const content = this.messageInput.value.trim();
        if (!content || this.isProcessing) return;
        if (this.welcomeScreen) this.welcomeScreen.style.display = 'none';
        if (this.messagesContainer) this.messagesContainer.style.display = 'block';
        this.messages.push({ role: 'user', content: content, interface: 'web' });
        this.renderMessages();
        this.messageInput.value = '';
        this.autoResize();
        this.setProcessing(true);
        this.addStreamingMessage();
        // Use SSE for streaming
        this.sendViaSSE(content);
    }
    sendViaSSE(content) {
        const url = `${this.apiBase}/api/chat/stream?message=${encodeURIComponent(content)}&session_id=${encodeURIComponent(this.sessionId)}`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('SSE event:', data.type);
                this.handleSSEMessage(data);

                if (data.type === 'complete' || data.type === 'error') {
                    eventSource.close();
                }
            } catch (e) {
                console.error('Failed to parse SSE message:', e, event.data);
            }
        };

        eventSource.onerror = (error) => {
            console.error('SSE error:', error);
            eventSource.close();
            // Only show error if still processing (not already completed)
            if (this.isProcessing) {
                this.handleError('Connection lost. Retrying...');
                // Fallback to REST
                this.sendViaRest(content);
            }
        };
    }
    async sendViaRest(content) {
        try {
            const response = await fetch(`${this.apiBase}/api/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: content, session_id: this.sessionId }) });
            const data = await response.json();
            const streamingEl = document.getElementById('streaming-message');
            if (streamingEl) streamingEl.remove();
            const statusEl = document.getElementById('status-indicator');
            if (statusEl) statusEl.remove();
            if (data.success) { this.messages.push({ role: 'assistant', content: data.content, interface: 'web', output_path: data.output_path }); this.renderMessages(); }
            else { this.addErrorMessage(data.error || 'Unknown error'); }
        } catch (error) { console.error('REST request failed:', error); this.addErrorMessage(error.message); }
        finally { this.setProcessing(false); }
    }
    addStreamingMessage() {
        const messageEl = document.createElement('div');
        messageEl.id = 'streaming-message';
        messageEl.className = 'message assistant';
        messageEl.innerHTML = `<div class="message-avatar">J</div><div class="message-content"><div class="message-role">Jotty</div><div class="message-text"></div><div class="message-meta"><span class="message-interface">web</span></div></div>`;
        this.messagesContainer.appendChild(messageEl);
        this.scrollToBottom();
    }
    addErrorMessage(error) {
        const errorEl = document.createElement('div');
        errorEl.className = 'error-message';
        errorEl.textContent = `Error: ${error}`;
        this.messagesContainer.appendChild(errorEl);
        this.scrollToBottom();
    }
    renderMessages() {
        if (!this.messagesContainer) return;
        this.messagesContainer.innerHTML = this.messages.map(msg => `<div class="message ${msg.role}"><div class="message-avatar">${msg.role === 'user' ? 'U' : 'J'}</div><div class="message-content"><div class="message-role">${msg.role === 'user' ? 'You' : 'Jotty'}</div><div class="message-text">${this.renderMarkdown(msg.content)}</div><div class="message-meta"><span class="message-interface">${msg.interface || 'web'}</span>${msg.output_path ? `<span class="output-path">Saved: ${msg.output_path}</span>` : ''}</div></div></div>`).join('');
        this.scrollToBottom();
    }
    renderMarkdown(text) {
        if (!text) return '';
        let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code class="language-${lang || ''}">${code.trim()}</code></pre>`);
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/^- \[x\] (.+)$/gm, '<li class="checked">‚òë $1</li>');
        html = html.replace(/^- \[ \] (.+)$/gm, '<li class="unchecked">‚òê $1</li>');
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
        html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul>$&</ul>');
        html = html.replace(/^(?!<[huplo]|$)(.+)$/gm, '<p>$1</p>');
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        return html;
    }
    setProcessing(processing) { this.isProcessing = processing; this.sendBtn.disabled = processing; this.messageInput.disabled = processing; if (!processing) this.messageInput.focus(); }
    handleKeydown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); } }
    autoResize() { this.messageInput.style.height = 'auto'; this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 200) + 'px'; }
    scrollToBottom() { if (this.chatArea) this.chatArea.scrollTop = this.chatArea.scrollHeight; }
    toggleSidebar() { if (this.sidebar) this.sidebar.classList.toggle('visible'); }
}
document.addEventListener('DOMContentLoaded', () => { window.jottyApp = new JottyApp(); });
    </script>
</body>
</html>
